<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Mir Dujanah Ali Hussaini</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9J7MJXMGGW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-9J7MJXMGGW');
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html">
                    <svg class="nav-logo-img" width="40" height="40" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="45" fill="#2563eb" opacity="0.9"/>
                        <text x="50" y="65" text-anchor="middle" fill="white" font-size="40" font-family="Inter, sans-serif" font-weight="bold">MD</text>
                    </svg>
                    <span class="nav-logo-text">Mir Dujanah</span>
                </a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
                <li class="nav-item"><a href="blog.html" class="nav-link">Blog</a></li>
                <li class="nav-item"><a href="analytics.html" class="nav-link active">Analytics</a></li>
            </ul>
            <div class="theme-switch desktop-theme">
                <input type="checkbox" id="themeToggle" class="theme-checkbox">
                <label for="themeToggle" class="theme-label">
                    <span class="theme-slider"></span>
                </label>
            </div>
        </div>
    </nav>

    <section class="analytics-hero">
        <div class="container">
            <h1>Website Analytics</h1>
            <p>Track visitor statistics and engagement</p>
        </div>
    </section>

    <section class="analytics-stats">
        <div class="container">
            <div class="analytics-controls">
                <button id="exportData" class="btn btn-primary">Export Data</button>
                <button id="refreshData" class="btn btn-secondary">Refresh</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="visitCount">Loading...</h3>
                        <p>Total Visits</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="resumeDownloads">Loading...</h3>
                        <p>Resume Downloads</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="portfolioDownloads">Loading...</h3>
                        <p>Portfolio Downloads</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="contactSubmissions">Loading...</h3>
                        <p>Contact Submissions</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="avgTimeOnSite">Loading...</h3>
                        <p>Avg. Time on Site</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="conversionRate">Loading...</h3>
                        <p>Conversion Rate</p>
                    </div>
                </div>
            </div>
            
            <div class="analytics-details">
                <div class="detail-section">
                    <h3>Top Projects</h3>
                    <div id="topProjects" class="detail-list">Loading...</div>
                </div>
                
                <div class="detail-section">
                    <h3>Device Breakdown</h3>
                    <div id="deviceBreakdown" class="detail-list">Loading...</div>
                </div>
                
                <div class="detail-section">
                    <h3>Top Referrers</h3>
                    <div id="topReferrers" class="detail-list">Loading...</div>
                </div>
                
                <div class="detail-section">
                    <h3>Download Statistics</h3>
                    <div class="download-stats">
                        <div class="stat-item">
                            <span>Resume Downloads:</span>
                            <span id="resumeDownloadCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span>Portfolio Downloads:</span>
                            <span id="portfolioDownloadCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span>Top Download Source:</span>
                            <span id="topDownloadSource">Hero Section</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="analytics-dashboard.js"></script>
    <script src="download-tracker.js"></script>
    <script>
        // Analytics page theme toggle
        function updateAnalyticsTheme(isDark) {
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
            
            // Safari-specific fixes for analytics page
            let safariStyle = document.getElementById('safari-analytics-dark');
            if (!safariStyle) {
                safariStyle = document.createElement('style');
                safariStyle.id = 'safari-analytics-dark';
                document.head.appendChild(safariStyle);
            }
            
            if (isDark) {
                safariStyle.textContent = `
                    body, html { background: #1a1a1a !important; color: #ffffff !important; }
                    .analytics-hero, .analytics-stats { background: #1a1a1a !important; }
                    .stat-card, .detail-section { background: #2d2d2d !important; border: 1px solid rgba(255,255,255,0.1) !important; }
                    .navbar { background: rgba(26,26,26,0.95) !important; }
                    h1, h2, h3, p, span { color: #ffffff !important; }
                `;
            } else {
                safariStyle.textContent = '';
            }
            
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        
        // Initialize theme on analytics page
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const isDark = savedTheme === 'dark';
            const themeToggle = document.getElementById('themeToggle');
            
            if (themeToggle) {
                themeToggle.checked = isDark;
                updateAnalyticsTheme(isDark);
                
                themeToggle.addEventListener('change', function() {
                    updateAnalyticsTheme(this.checked);
                });
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize analytics display with multiple attempts
            let attempts = 0;
            const maxAttempts = 5;
            
            function initializeDisplay() {
                attempts++;
                
                if (window.portfolioAnalytics && typeof window.portfolioAnalytics.generateReport === 'function') {
                    updateAnalyticsDisplay();
                    console.log('Analytics display initialized successfully');
                } else if (attempts < maxAttempts) {
                    setTimeout(initializeDisplay, 200 * attempts);
                } else {
                    console.warn('Analytics initialization failed after', maxAttempts, 'attempts');
                    showFallbackData();
                }
            }
            
            initializeDisplay();
            
            // Setup event listeners after DOM is ready
            setTimeout(() => {
                const exportBtn = document.getElementById('exportData');
                const refreshBtn = document.getElementById('refreshData');
                
                if (exportBtn) {
                    exportBtn.addEventListener('click', function() {
                        const btn = this;
                        const originalText = btn.textContent;
                        
                        try {
                            btn.textContent = 'Exporting...';
                            btn.disabled = true;
                            
                            window.portfolioAnalytics.exportData();
                            
                            btn.textContent = 'Exported!';
                            setTimeout(() => {
                                btn.textContent = originalText;
                                btn.disabled = false;
                            }, 2000);
                        } catch (error) {
                            console.error('Export failed:', error);
                            btn.textContent = 'Error';
                            setTimeout(() => {
                                btn.textContent = originalText;
                                btn.disabled = false;
                            }, 2000);
                        }
                    });
                }
                
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', function() {
                        const btn = this;
                        const originalText = btn.textContent;
                        
                        try {
                            btn.textContent = 'Refreshing...';
                            btn.disabled = true;
                            
                            if (window.portfolioAnalytics) {
                                const report = window.portfolioAnalytics.generateReport();
                                console.log('Analytics refreshed:', report);
                            }
                            
                            updateAnalyticsDisplay();
                            
                            btn.textContent = 'Refreshed!';
                            setTimeout(() => {
                                btn.textContent = originalText;
                                btn.disabled = false;
                            }, 1500);
                        } catch (error) {
                            console.error('Refresh failed:', error);
                            btn.textContent = 'Error';
                            setTimeout(() => {
                                btn.textContent = originalText;
                                btn.disabled = false;
                            }, 2000);
                        }
                    });
                }
            }, 500);
        });
        
        function updateAnalyticsDisplay() {
            try {
                const report = window.portfolioAnalytics.generateReport();
                
                // Update main stats with precise formatting
                updateElement('visitCount', report.totalVisits.toLocaleString());
                updateElement('resumeDownloads', report.resumeDownloads.toLocaleString());
                updateElement('portfolioDownloads', report.portfolioDownloads.toLocaleString());
                updateElement('contactSubmissions', report.contactSubmissions.toLocaleString());
                updateElement('avgTimeOnSite', formatTime(report.avgTimeOnSite));
                updateElement('conversionRate', report.conversionRate + '%');
                
                // Update detailed sections
                updateTopProjects(report.topProjects);
                updateDeviceBreakdown(report.deviceBreakdown);
                updateTopReferrers(report.topReferrers);
                updateDownloadStats(report);
                
                // Show data quality info
                if (report.dataQuality) {
                    console.log('Analytics Data Quality:', report.dataQuality);
                }
            } catch (error) {
                console.error('Analytics display update failed:', error);
                showFallbackData();
            }
        }
        
        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }
        
        function showFallbackData() {
            updateElement('visitCount', '0');
            updateElement('resumeDownloads', '0');
            updateElement('portfolioDownloads', '0');
            updateElement('contactSubmissions', '0');
            updateElement('avgTimeOnSite', '0:00');
            updateElement('conversionRate', '0.00%');
        }
        
        function updateDownloadStats(report) {
            try {
                updateElement('resumeDownloadCount', report.resumeDownloads.toLocaleString());
                updateElement('portfolioDownloadCount', report.portfolioDownloads.toLocaleString());
                
                // Determine top download source based on data
                let topSource = 'Direct Access';
                if (report.topReferrers && report.topReferrers.length > 0) {
                    const [referrer] = report.topReferrers[0];
                    if (referrer !== 'direct') {
                        topSource = referrer.charAt(0).toUpperCase() + referrer.slice(1);
                    }
                }
                updateElement('topDownloadSource', topSource);
                
                // Add total downloads if element exists
                if (document.getElementById('totalDownloads')) {
                    updateElement('totalDownloads', report.totalDownloads.toLocaleString());
                }
            } catch (error) {
                console.log('Download stats update error:', error);
            }
        }
        
        function formatTime(seconds) {
            if (!seconds || seconds < 0) return '0:00';
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            
            if (mins >= 60) {
                const hours = Math.floor(mins / 60);
                const remainingMins = mins % 60;
                return `${hours}h ${remainingMins}m`;
            }
            
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function updateTopProjects(projects) {
            const container = document.getElementById('topProjects');
            if (!container) return;
            
            if (!projects || projects.length === 0) {
                container.innerHTML = `
                    <div class="detail-item">
                        <span>Sanitizable Access Control System</span>
                        <span class="detail-value">Security Project</span>
                    </div>
                    <div class="detail-item">
                        <span>Handwritten Digits Classification</span>
                        <span class="detail-value">AI/ML Project</span>
                    </div>
                    <div class="detail-item">
                        <span>News Classification Using NLP</span>
                        <span class="detail-value">NLP Project</span>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = projects.map(([name, views]) => 
                `<div class="detail-item">
                    <span>${name}</span>
                    <span class="detail-value">${views.toLocaleString()} view${views !== 1 ? 's' : ''}</span>
                </div>`
            ).join('');
        }
        
        function updateDeviceBreakdown(devices) {
            const container = document.getElementById('deviceBreakdown');
            if (!container) return;
            
            const entries = Object.entries(devices || {}).filter(([,count]) => count > 0);
            
            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="detail-item">
                        <span>Desktop</span>
                        <span class="detail-value">Optimized</span>
                    </div>
                    <div class="detail-item">
                        <span>Mobile</span>
                        <span class="detail-value">Responsive</span>
                    </div>
                    <div class="detail-item">
                        <span>Tablet</span>
                        <span class="detail-value">Compatible</span>
                    </div>
                `;
                return;
            }
            
            // Sort by count and calculate percentages
            const total = entries.reduce((sum, [,count]) => sum + count, 0);
            const sortedEntries = entries.sort(([,a], [,b]) => b - a);
            
            container.innerHTML = sortedEntries.map(([device, count]) => {
                const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                return `<div class="detail-item">
                    <span>${device.charAt(0).toUpperCase() + device.slice(1)}</span>
                    <span class="detail-value">${count.toLocaleString()} (${percentage}%)</span>
                </div>`;
            }).join('');
        }
        
        function updateTopReferrers(referrers) {
            const container = document.getElementById('topReferrers');
            if (!container) return;
            
            if (!referrers || referrers.length === 0) {
                container.innerHTML = `
                    <div class="detail-item">
                        <span>Direct Access</span>
                        <span class="detail-value">Primary</span>
                    </div>
                    <div class="detail-item">
                        <span>Search Engines</span>
                        <span class="detail-value">Discovery</span>
                    </div>
                    <div class="detail-item">
                        <span>Social Media</span>
                        <span class="detail-value">Sharing</span>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = referrers.map(([referrer, count]) => {
                const displayName = referrer === 'direct' ? 'Direct Access' : 
                                  referrer.charAt(0).toUpperCase() + referrer.slice(1);
                return `<div class="detail-item">
                    <span>${displayName}</span>
                    <span class="detail-value">${count.toLocaleString()} visit${count !== 1 ? 's' : ''}</span>
                </div>`;
            }).join('');
        }
    </script>
</body>
</html>